<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

	<meta name="theme-color" content="#2c3e50">
  	<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Getting the most out of Artifactory &middot; Jeroen Mols
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Fonts -->
  <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

  <!-- Icons -->
  <link rel="favicon-144-precomposed" sizes="144x144" href="/public/favicon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63356566-1', 'auto');
  ga('send', 'pageview');

</script>

  	<body class="theme-base-custom">
	    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about sidebar-title">
      
      <img class="img-responsive" src="/img/profile.png" alt="">

      <h1>
        <a class="sidebar-link" href="/blog">
          Jeroen Mols
        </a>
      </h1>

      <ul class="list-inline">
        
          <li>
              <a href="https://twitter.com/molsjeroen" class="btn-social btn-outline" target="blank"><i class="fa fa-fw fa-twitter"></i></a>
          </li>
        
          <li>
              <a href="https://stackoverflow.com/users/2771851/jmols" class="btn-social btn-outline" target="blank"><i class="fa fa-fw fa-stack-overflow"></i></a>
          </li>
        
          <li>
              <a href="https://github.com/JeroenMols" class="btn-social btn-outline" target="blank"><i class="fa fa-fw fa-github"></i></a>
          </li>
        
          <li>
              <a href="https://be.linkedin.com/pub/jeroen-mols/25/a62/995" class="btn-social btn-outline" target="blank"><i class="fa fa-fw fa-linkedin"></i></a>
          </li>
        
          <li>
              <a href="https://speakerdeck.com/jeroenmols" class="btn-social btn-outline" target="blank"><i class="fa fa-fw fa-file-pdf-o"></i></a>
          </li>
        
      </ul>

      <p class="sidebar-subtitle">Android developer with a great <a class="sidebar-link" href="/">portfolio</a>.</p>
    </div>

    <div class="copyright">
      <p>Copyright &copy; Jeroen Mols 2015</p>
    </div>
  </div>
</div>

	    <div class="content container">
	      	<div class="post">
  <h1 class="post-title">Getting the most out of Artifactory</h1>
  <span class="post-date">13 Aug 2015</span>

  
   <img src="/img/blog/artifactory2/artifactory2.png" alt="Getting the most out of Artifactory">
  
 
  <p>My previous <a href="/blog/2015/08/06/artifactory/">blog post</a> described how to set up your own private Maven repository with Artifactory in 30 minutes. This second and final part will make things more interesting and take your setup to the next level.</p>

<p>You will learn how to:</p>

<ul>
<li>handle library projects with dependencies</li>
<li>securely provide username and password</li>
<li>work with snapshot and release builds</li>
<li>configure custom repositories</li>
<li>manage user access</li>
</ul>

<p>All source code is <a href="https://github.com/JeroenMols/ArtifactoryExample">available on Github</a> as usual.</p>

<p>Note that the material presented here can quite easily be extended to be applicable beyond Android.</p>

<h2>Library projects with dependencies</h2>

<p>Imagine if your Android library project itself has dependencies. Then the application using the library wouldn&#39;t be able to run unless it provides all dependencies the library requires.</p>

<p>To better understand this, consider the new <a href="https://github.com/JeroenMols/ArtifactoryExample/blob/master/AwesomeAdvancedLibrary/awesomeadvancedlibrary/src/main/java/com/jeroenmols/awesomeadvancedlibrary/AwesomeConvertor.java"><code>AwesomeAdvancedLibrary</code></a> which makes use of <a href="https://github.com/google/guava">Guava</a> to <em>awesomize</em> a <code>String</code>. The application using this library should be agnostic of this dependency. Hence we do not want to define two dependencies:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="s1">&#39;com.jeroenmols.awesomeadvancedlibrary:awesomeadvancedlibrary:1.0.0&#39;</span>
    <span class="n">compile</span> <span class="s1">&#39;com.google.guava:guava:18.0&#39;</span>
<span class="o">}</span>
</code></pre></div>
<p>Instead one <code>compile</code> dependency should suffice to use the library.</p>

<blockquote>
<p><strong>Important note on including dependencies</strong></p>

<p>You can <em>skip this if you want</em>, just some extra context</p>

<p>Including dependencies in your library is not always a good idea, because this can lead to a dependency conflict while integrating. I only choose Guava to keep things simple, but it is actually a very bad example as it is a utility library. This means it&#39;s quite likely that the app also needs it.</p>

<p>A better example would be a universal <em>analytics</em> library offering a universal API to track analytics and redirecting all calls internally to one or more analytics providers. Here packaging dependencies makes sense, because the app never needs to talk to the dependency directly. It also hides implementation details, so the app doesn&#39;t need to be modified when switching to a new provider.</p>
</blockquote>

<p>Imagine if we would simply resort to the buildscript we had in my previous <a href="/blog/2015/08/06/artifactory/">blogpost</a>. At compile time the <code>Guava</code> dependency will not be included, because the would make the library unnecessarily large. Instead, the compiler will tell the library: &quot;don&#39;t worry about this dependency, the app will provide it for you.&quot;</p>

<p>The app on the other hand wouldn&#39;t have a clue which dependencies the library actually needs (how would it?) and hence the app will compile just fine. However, after starting the app and trying to access the library, the app would crash at runtime:</p>
<div class="highlight"><pre><code class="language-Java" data-lang="Java"><span class="mi">08</span><span class="o">-</span><span class="mi">09</span> <span class="mi">20</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span><span class="mf">46.096</span>  <span class="mi">28892</span><span class="o">-</span><span class="mi">28892</span><span class="o">/?</span> <span class="n">E</span><span class="o">/</span><span class="n">AndroidRuntime</span><span class="err">ï¹•</span> <span class="n">FATAL</span> <span class="nl">EXCEPTION:</span> <span class="n">main</span>
<span class="nl">Process:</span> <span class="n">com</span><span class="o">.</span><span class="na">jeroenmols</span><span class="o">.</span><span class="na">awesomeadvancedapplication</span><span class="o">,</span> <span class="nl">PID:</span> <span class="mi">28892</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NoClassDefFoundError</span><span class="o">:</span> <span class="n">Failed</span> <span class="n">resolution</span> <span class="nl">of:</span> <span class="n">Lcom</span><span class="o">/</span><span class="n">google</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">CharMatcher</span><span class="o">;</span>
    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">jeroenmols</span><span class="o">.</span><span class="na">awesomeadvancedlibrary</span><span class="o">.</span><span class="na">AwesomeConvertor</span><span class="o">.</span><span class="na">toAwesome</span><span class="o">(</span><span class="n">AwesomeConvertor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
</code></pre></div>
<p>To solve this, we need to ensure that the library <code>pom.xml</code> file  contains the right dependencies by manually adding the <code>pom.withXml{}</code> element to the <code>publishing task</code>:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">publishing</span> <span class="o">{</span>
    <span class="n">publications</span> <span class="o">{</span>
        <span class="n">aar</span><span class="o">(</span><span class="n">MavenPublication</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">groupId</span> <span class="n">packageName</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">libraryVersion</span>
            <span class="n">artifactId</span> <span class="n">project</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
            <span class="n">artifact</span><span class="o">(</span><span class="s2">&quot;$buildDir/outputs/aar/${project.getName()}-release.aar&quot;</span><span class="o">)</span>

            <span class="n">pom</span><span class="o">.</span><span class="na">withXml</span> <span class="o">{</span>
                <span class="kt">def</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="n">asNode</span><span class="o">().</span><span class="na">appendNode</span><span class="o">(</span><span class="s1">&#39;dependencies&#39;</span><span class="o">)</span>
                <span class="n">configurations</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s2">&quot;_releaseCompile&quot;</span><span class="o">).</span><span class="na">getResolvedConfiguration</span><span class="o">().</span><span class="na">getFirstLevelModuleDependencies</span><span class="o">().</span><span class="na">each</span> <span class="o">{</span>
                    <span class="kt">def</span> <span class="n">dependency</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="na">appendNode</span><span class="o">(</span><span class="s1">&#39;dependency&#39;</span><span class="o">)</span>
                    <span class="n">dependency</span><span class="o">.</span><span class="na">appendNode</span><span class="o">(</span><span class="s1">&#39;groupId&#39;</span><span class="o">,</span> <span class="n">it</span><span class="o">.</span><span class="na">moduleGroup</span><span class="o">)</span>
                    <span class="n">dependency</span><span class="o">.</span><span class="na">appendNode</span><span class="o">(</span><span class="s1">&#39;artifactId&#39;</span><span class="o">,</span> <span class="n">it</span><span class="o">.</span><span class="na">moduleName</span><span class="o">)</span>
                    <span class="n">dependency</span><span class="o">.</span><span class="na">appendNode</span><span class="o">(</span><span class="s1">&#39;version&#39;</span><span class="o">,</span> <span class="n">it</span><span class="o">.</span><span class="na">moduleVersion</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Note that while you can similarly add other repositories in this way to the <code>pom.xml</code>, Gradle itself <a href="https://discuss.gradle.org/t/resolving-problem-when-maven-repo-contains-pom-but-not-jar/7174">won&#39;t look</a> for repositories in that file. Therefore if you use libraries from 3rd party repositories, you still need to add those repositories to the <code>build.gradle</code> of your app.</p>

<h2>Securely provide username and password</h2>

<p>Obviously we do not want to store a plain text username and password in any file that we check in to our version control system. So to make sure we hide those, create a <code>gradle.properties</code> file in the root of your project and add the following content:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">artifactory_username</span><span class="o">=</span><span class="n">admin</span>
<span class="n">artifactory_password</span><span class="o">=</span><span class="n">password</span>
</code></pre></div>
<p>Then in your <code>build.gradle</code> file, refer to the properties like this:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">username</span> <span class="o">=</span> <span class="n">artifactory_username</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">artifactory_password</span>
</code></pre></div>
<p>We have now obfuscated the password, so it is no longer in the <code>build.gradle</code> file, but people can still find it in the <code>gradle.properties</code> file under version control. To prevent this, you must do one of the following:</p>

<ul>
<li>Don&#39;t add <code>gradle.properties</code> to your version control system. (add it to your <code>.gitignore</code> file instead)</li>
<li>Move the <code>gradle.properties</code> to the base <code>~/.gradle</code> folder on your hard drive. I personally recommend this approach as you can never accidentally check in your username and password.</li>
</ul>

<h2>Working with Snapshot and Release builds</h2>

<p>While the Artifactory Gradle plugin doesn&#39;t have support for snapshot/release builds out of the box, it is easy to add this functionality by relying on the artifact version:</p>

<ul>
<li>For release builds: use <a href="http://semver.org/">symantic versioning</a> e.g. <code>1.0.0</code></li>
<li>For Snapshot builds: use symantic versioning with <code>-SNAPSHOT</code> suffix e.g. <code>1.0.0-SNAPSHOT</code></li>
</ul>

<p>Now you can direct each one to a different Artifactory repository by changing the repository key as follows:</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">repoKey</span> <span class="o">=</span> <span class="n">libraryVersion</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s1">&#39;SNAPSHOT&#39;</span><span class="o">)</span> <span class="o">?</span> <span class="s1">&#39;libs-snapshot-local&#39;</span> <span class="o">:</span> <span class="s1">&#39;libs-release-local&#39;</span>
</code></pre></div>
<p>On the application side you need to add two different Maven urls so you can refer to artifacts in both repositories.</p>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">allprojects</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
      <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">&quot;http://localhost:8081/artifactory/libs-release-local&quot;</span> <span class="o">}</span>
      <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">&quot;http://localhost:8081/artifactory/libs-snapshot-local&quot;</span> <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Referencing artifacts is exactly the same as before, just don&#39;t forget to add the <code>-SNAPSHOT</code> suffix for snapshot artifacts.</p>

<p>Alternatively we can also create a <code>virtual</code> repository in Artifactory which wraps around both repositories. This way the app only requires one URL, but does create a dependency on the existing Artifactory setup.</p>

<ol>
<li>Login to Artifactory and go to admin &gt; repositories &gt; virtual
<center><a href="/img/blog/artifactory2/artifactory2_virtualrepo1.png"><img src="/img/blog/artifactory2/artifactory2_virtualrepo1.png" alt="All virtual repositories can be found under admin - repositories - virtual"></a></center></li>
<li>Create a new virtual maven repository which contains both <code>libs-release-local</code> and <code>libs-snapshot-local</code>
<center><a href="/img/blog/artifactory2/artifactory2_virtualrepo2.png"><img src="/img/blog/artifactory2/artifactory2_virtualrepo2.png" alt="Create a new virtual maven repository which contains both libs-release-local and libs-snapshot-local"></a></center></li>
<li>In the top level <code>build.gradle</code> of your application, replace the two previous URLS by the following:</li>
</ol>
<div class="highlight"><pre><code class="language-groovy" data-lang="groovy">  <span class="n">allprojects</span> <span class="o">{</span>
      <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">&quot;http://localhost:8081/artifactory/libs-local&quot;</span> <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>
<h2>User access management</h2>

<p>Currently everyone can both read and write to all your repositories. This is not a good idea, especially if your server is also connected to the internet. Therefore we are going to set up two different users: one to deploy artifacts and one to consume artifacts.</p>

<p>In order to do so, go to artifactory and login as <code>admin</code>. Now navigate to admin &gt; security &gt; general and make the following changes:</p>

<ul>
<li>set <code>Allow Anonymous Access</code> to false -&gt; ensures only known Artifactory users can consume artifacts</li>
<li>set <code>Password Encryption Policy</code> to <code>REQUIRED</code> -&gt; ensures we don&#39;t have to hardcode a plain text password in our <code>build.gradle</code>.</li>
<li>press the <code>encrypt</code> button in the <code>Password Encyption</code> section -&gt; encrypts all passwords</li>
</ul>

<p>If the app now tries to consume an artifact, it will get a <code>401</code> error: unauthorized. You can verify this yourself by clearing the gradle cache (to force a dependency download):</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">gradle clean --refresh-dependencies
</code></pre></div>
<p>Next, go to the <code>Users</code> pane and add two new user: <code>consumer</code> and <code>deployer</code>. Make sure not to add them to any group.</p>

<p><center><a href="/img/blog/artifactory2/artifactory2_user1.png"><img src="/img/blog/artifactory2/artifactory2_user1.png" alt="Settings for consumer user"></a></center></p>

<p><center><a href="/img/blog/artifactory2/artifactory2_user2.png"><img src="/img/blog/artifactory2/artifactory2_user2.png" alt="Settings for deployer user"></a></center></p>

<p>Note that you probably also want to change your admin password at this stage. ;)</p>

<p>Now go to the <code>Permissions</code> pane and add a new <code>Consume Libraries</code> permission. Set the Selected repositories to include the snapshot and release repository, and in the <code>Users</code> tab add the <code>consumer</code> user with read permissions.</p>

<p><center><a href="/img/blog/artifactory2/artifactory2_permission1.png"><img src="/img/blog/artifactory2/artifactory2_permission1.png" alt="Settings for Consume Libraries permission"></a></center></p>

<p><center><a href="/img/blog/artifactory2/artifactory2_permission2.png"><img src="/img/blog/artifactory2/artifactory2_permission2.png" alt="Settings for Consume Libraries permission"></a></center></p>

<p>Add a second permission: <code>Deploy Libraries</code> with the snapshot and release repository included. Here give the <code>deployer</code> user <code>Deploy/Cache</code> permission but not <code>Delete/Overwrite</code> as you never want to override an existing artifact!</p>

<p><center><a href="/img/blog/artifactory2/artifactory2_permission3.png"><img src="/img/blog/artifactory2/artifactory2_permission3.png" alt="Settings for Deploy Libraries permission"></a></center></p>

<p><center><a href="/img/blog/artifactory2/artifactory2_permission4.png"><img src="/img/blog/artifactory2/artifactory2_permission4.png" alt="Settings for Deploy Libraries permission"></a></center></p>

<p>All we need to do now is modify the Library and Application to make use of these new users. This is easy for the Library as you can simply replace the <code>admin</code> user with the <code>deploy</code> user in the <code>gradle.properties</code> file.</p>

<p>For the Application we will need to provide credentials to access the Maven repository. Here we will hard code the username and password in the top level <code>build.gradle</code> file because team members should be able to checkout and build the code without extra configuration.</p>

<p>Therefore we will take some extra security precautions:</p>

<ul>
<li>Use a user with read access to only a small subset of our repositories: <code>deploy</code>.</li>
<li>Check the code into a private repository, so the hardcoded password is protected by repository password.</li>
<li><p>Use the encrypted version of the password instead of the plain text version:</p>

<ul>
<li>Login to artifactory as the <code>consumer</code> user</li>
<li>Navigate to the user settings in the top right corner</li>
<li>Unlock your profile with your password</li>
<li>Copy the API key</li>
</ul>

<p><center><a href="/img/blog/artifactory2/artifactory2_consumer.png"><img src="/img/blog/artifactory2/artifactory2_consumer.png" alt="Copy the API key from the consumer profile."></a></center></p></li>
</ul>

<p>Now add the user authentication to the top level <code>build.gradle</code> file:</p>
<div class="highlight"><pre><code class="language-Groovy" data-lang="Groovy"><span class="n">allprojects</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">jcenter</span><span class="o">()</span>
        <span class="c1">// NOTE: configure your virtual repository and user in artifactory to make this work</span>
        <span class="n">maven</span> <span class="o">{</span>
            <span class="n">url</span> <span class="s2">&quot;http://localhost:8081/artifactory/libs-local&quot;</span>
            <span class="n">credentials</span> <span class="o">{</span>
                <span class="n">username</span> <span class="s1">&#39;consumer&#39;</span>
                <span class="n">password</span> <span class="s1">&#39;APA52uxnRkmxeRXmJqd7haMpwgg&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>And we are all set with authenticated access to our repositories.</p>

<h2>Wrap-up</h2>

<p>That&#39;s a wrap to my two part blogpost about Artifactory! We made our previous repository a lot more secure, added support for dependencies and can now differentiate between release and snapshot artifacts.</p>

<p>No more excuses not to write reusable code!</p>

<p>Feel free to leave a comment and don&#39;t forget to check the <a href="https://github.com/JeroenMols/ArtifactoryExample">full source code</a> on Github.</p>

</div>


<h2>Comments</h2>
<section class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'jeroenmols';
      
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</section>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      
      
    
      
        <li>
          <h3>
            <a href="/blog/2015/08/06/artifactory/">
              A private Maven repository for Android in 30 min
              <small>06 Aug 2015</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/blog/2015/04/25/blog-creation/">
              How I created my blog
              <small>25 Apr 2015</small>
            </a>
          </h3>
        </li>
      
    
  </ul>
</div>
	    </div>
  	</body>
</html>
